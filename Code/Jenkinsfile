pipeline {
    agent any
    
    environment {
        EC2_IP = "23.22.57.128"
    }

    stages {
        stage('ğŸ“¥ Checkout') {
            steps {
                echo "1. ğŸ“¥ Baixando cÃ³digo..."
                checkout scm
            }
        }

        stage('ğŸ” Verificar Estrutura') {
            steps {
                echo "2. ğŸ” Verificando arquivos..."
                dir('Code') {
                    sh '''
                        echo "=== BACKEND ==="
                        ls -la backend/ && echo "âœ… Backend encontrado" || echo "âŒ Backend nÃ£o encontrado"
                        echo "=== FRONTEND ==="  
                        ls -la frontend/ && echo "âœ… Frontend encontrado" || echo "âŒ Frontend nÃ£o encontrado"
                        echo "=== DOCKERFILES ==="
                        cat backend/Dockerfile | head -3 && echo "âœ… Dockerfile backend OK" || echo "âŒ Dockerfile backend problema"
                        cat frontend/Dockerfile | head -3 && echo "âœ… Dockerfile frontend OK" || echo "âŒ Dockerfile frontend problema"
                    '''
                }
            }
        }

        stage('ğŸ³ Build Frontend') {
            steps {
                echo "3. ğŸ³ Construindo Frontend..."
                dir('Code') {
                    sh 'timeout 300 docker build -t code-frontend -f frontend/Dockerfile ./frontend || echo "âš ï¸ Build frontend pode ter demorado muito"'
                }
            }
        }

        stage('ğŸ³ Build Backend') {
            steps {
                echo "4. ğŸ³ Construindo Backend..."
                dir('Code') {
                    sh 'timeout 300 docker build -t code-backend -f backend/Dockerfile ./backend || echo "âš ï¸ Build backend pode ter demorado muito"'
                }
            }
        }

        stage('ğŸš€ Deploy') {
            steps {
                echo "5. ğŸš€ Implantando containers..."
                script {
                    sh '''
                        echo "ğŸ›‘ Limpando containers antigos..."
                        docker stop code-frontend-1 code-backend-1 2>/dev/null || true
                        docker rm code-frontend-1 code-backend-1 2>/dev/null || true
                        
                        echo "ğŸ¯ Iniciando Backend..."
                        docker run -d --name code-backend-1 -p 3000:3000 code-backend || echo "âŒ Backend falhou"
                        
                        echo "ğŸ¯ Iniciando Frontend..." 
                        docker run -d --name code-frontend-1 -p 80:80 code-frontend || echo "âŒ Frontend falhou"
                        
                        echo "â³ Aguardando inicializaÃ§Ã£o..."
                        sleep 20
                    '''
                }
            }
        }
        
        stage('âœ… VerificaÃ§Ã£o Final') {
            steps {
                echo "6. âœ… Verificando deploy..."
                script {
                    sh 'docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"'
                    sh '''
                        echo " "
                        echo "ğŸ§ª Testes de conectividade:"
                        curl -s -o /dev/null -w "Frontend: %{http_code}\\n" http://localhost:80
                        curl -s -o /dev/null -w "Backend: %{http_code}\\n" http://localhost:3000
                        echo " "
                    '''
                    sh """
                        echo "ğŸ‰ DEPLOY CONCLUÃDO!"
                        echo "ğŸŒ Seu app estÃ¡ em: http://${EC2_IP}"
                        echo "ğŸ”§ API estÃ¡ em: http://${EC2_IP}:3000"
                        echo " "
                        echo "ğŸ’¡ Dica: Se as mudanÃ§as nÃ£o aparecerem, tente:"
                        echo "   - Ctrl+F5 no navegador"
                        echo "   - Modo anÃ´nimo"
                        echo "   - Aguarde 1-2 minutos para DNS"
                    """
                }
            }
        }
    }

    post {
        always {
            echo "ğŸ Pipeline finalizado - Acesse: http://${EC2_IP}"
        }
    }
}