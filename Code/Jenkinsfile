pipeline {
    agent any
    
    environment {
        EC2_IP = "23.22.57.128"
    }

    stages {
        stage('ğŸ“¥ Checkout') {
            steps {
                echo "1. ğŸ“¥ Baixando cÃ³digo atualizado..."
                checkout scm
                sh 'echo "ğŸ“ Estrutura atual:" && ls -la Code/'
            }
        }

        stage('ğŸ”§ CorreÃ§Ã£o Requirements') {
            steps {
                echo "2. ğŸ”§ Corrigindo requirements.txt..."
                dir('Code') {
                    sh '''
                        echo "ğŸ” Verificando backend..."
                        ls -la backend/
                        
                        # CORRIGIR: Arquivo se chama 'requirments.txt' mas Dockerfile procura 'requirements.txt'
                        echo "ğŸ“ Corrigindo nome do arquivo..."
                        mv backend/requirments.txt backend/requirements.txt 2>/dev/null || echo "âœ… Arquivo jÃ¡ estÃ¡ correto"
                        
                        echo "âœ… Arquivo corrigido:"
                        ls -la backend/requirements.txt
                    '''
                }
            }
        }

        stage('ğŸ”¨ Build Backend') {
            steps {
                echo "3. ğŸ³ Construindo Backend..."
                dir('Code') {
                    sh 'docker build -t backend-app -f backend/Dockerfile ./backend || echo "âŒ Build backend falhou"'
                }
            }
        }

        stage('ğŸ”¨ Build Frontend') {
            steps {
                echo "4. ğŸ³ Construindo Frontend..."
                dir('Code') {
                    sh 'docker build -t frontend-app -f frontend/Dockerfile ./frontend || echo "âŒ Build frontend falhou"'
                }
            }
        }

        stage('ğŸš€ Deploy') {
            steps {
                echo "5. ğŸš€ Implantando containers..."
                script {
                    sh '''
                        echo "ğŸ›‘ Parando containers antigos..."
                        # PARA OS CONTAINERS QUE ESTÃƒO RODANDO (code-frontend-1, code-backend-1)
                        docker stop code-frontend-1 code-backend-1 2>/dev/null || true
                        docker rm code-frontend-1 code-backend-1 2>/dev/null || true
                        
                        echo "ğŸ¯ Iniciando novos containers..."
                        docker run -d --name code-backend-1 -p 3000:3000 backend-app || echo "âŒ Backend nÃ£o iniciou"
                        docker run -d --name code-frontend-1 -p 80:80 frontend-app || echo "âŒ Frontend nÃ£o iniciou"
                        
                        sleep 25
                    '''
                }
            }
        }
        
        stage('âœ… VerificaÃ§Ã£o') {
            steps {
                echo "6. âœ… Verificando deploy..."
                script {
                    sh 'docker ps --format "table {{.Names}}\t{{.Status}}\t{{.RunningFor}}"'
                    sh '''
                        echo "ğŸ§ª Testando serviÃ§os..."
                        curl -f http://localhost:3000 >/dev/null 2>&1 && echo "âœ… Backend respondendo" || echo "âŒ Backend offline"
                        curl -f http://localhost:80 >/dev/null 2>&1 && echo "âœ… Frontend respondendo" || echo "âŒ Frontend offline"
                    '''
                    sh """
                        echo " "
                        echo "ğŸ‰ DEPLOY CONCLUÃDO!"
                        echo "ğŸŒ Frontend: http://${EC2_IP}"
                        echo "ğŸ”§ Backend: http://${EC2_IP}:3000"
                        echo " "
                        echo "ğŸ“ Seu HTML atualizado deve estar visÃ­vel agora!"
                        echo " "
                    """
                }
            }
        }
    }

    post {
        always {
            echo "ğŸ§¹ Pipeline finalizado"
        }
        success {
            echo "âœ… SUCESSO! App atualizado em: http://${EC2_IP}"
        }
        failure {
            echo "âŒ Erro no pipeline."
        }
    }
}