pipeline {
    agent any
    
    environment {
        EC2_IP = sh(script: "curl -s http://169.254.169.254/latest/meta-data/public-ipv4", returnStdout: true).trim()
    }
    
    stages {
        stage('ğŸ“¥ Checkout Code') {
            steps {
                echo "1. ğŸ“¥ Baixando cÃ³digo..."
                checkout scm
                sh 'echo "ğŸ“ Estrutura raiz:" && ls -la'
                sh 'echo "ğŸ“ ConteÃºdo da pasta Code:" && ls -la Code/'
                sh 'echo "ğŸ“ Backend existe?" && ls -la Code/backend/ || echo "Pasta backend nÃ£o encontrada"'
                sh 'echo "ğŸ“ Frontend existe?" && ls -la Code/frontend/ || echo "Pasta frontend nÃ£o encontrada"'
            }
        }
        
        stage('ğŸ³ Build Images') {
            steps {
                echo "2. ğŸ³ Construindo imagens..."
                dir('Code') {
                    sh 'docker build -t frontend-app ./frontend || echo "âŒ Build frontend falhou"'
                    sh 'docker build -t backend-app ./backend || echo "âŒ Build backend falhou"'
                }
            }
        }
        
        stage('ğŸš€ Deploy') {
            steps {
                echo "3. ğŸš€ Deploy..."
                script {
                    sh 'docker stop frontend-app backend-app 2>/dev/null || true'
                    sh 'docker rm frontend-app backend-app 2>/dev/null || true'
                    sh 'docker run -d --name backend-app -p 3000:3000 backend-app || echo "âŒ Backend deploy falhou"'
                    sh 'docker run -d --name frontend-app -p 80:80 frontend-app || echo "âŒ Frontend deploy falhou"'
                    sleep 25
                }
            }
        }
        
        stage('âœ… Verify') {
            steps {
                echo "4. âœ… Verificando..."
                script {
                    sh 'docker ps'
                    sh """
                        echo " "
                        echo "ğŸ‰ STATUS DO DEPLOY:"
                        echo "ğŸŒ Frontend: http://${EC2_IP}"
                        echo "ğŸ”§ Backend: http://${EC2_IP}:3000"
                        echo "âš™ï¸ Jenkins: http://${EC2_IP}:8080"
                        echo " "
                    """
                }
            }
        }
    }
    
    post {
        always {
            echo "ğŸ§¹ Finalizando..."
            deleteDir()
        }
        success {
            echo "âœ… SUCESSO! App rodando em: http://${EC2_IP}"
        }
        failure {
            echo "âŒ Erro no pipeline."
        }
    }
}