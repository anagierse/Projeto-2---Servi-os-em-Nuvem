pipeline {
    agent any
    
    stages {
        stage('ğŸ“¥ Checkout') {
            steps {
                checkout scm
                sh '''
                    echo "âœ… CÃ³digo baixado"
                    echo "ğŸ“„ Verificando arquivo .env:"
                    ls -la Code/.env || echo "âŒ .env nÃ£o encontrado"
                    ls -la Code/env || echo "âŒ env nÃ£o encontrado"
                '''
            }
        }
        
        stage('ğŸš€ Deploy com Docker Compose') {
            steps {
                sh '''
                    echo "ğŸ¯ Usando Docker Compose para deploy..."
                    cd Code
                    
                    # Para os serviÃ§os sem remover volumes (mantÃ©m dados)
                    docker-compose down
                    
                    # ConstrÃ³i e sobe os serviÃ§os
                    docker-compose up -d --build
                    
                    echo "â³ Aguardando inicializaÃ§Ã£o..."
                    sleep 30
                '''
            }
        }
        
        stage('âœ… Health Check') {
            steps {
                sh '''
                    echo "ğŸ“Š Status dos serviÃ§os:"
                    cd Code && docker-compose ps
                    
                    echo "ğŸ” Verificando variÃ¡veis no backend:"
                    docker-compose -f Code/docker-compose.yml exec -T backend printenv | grep DB || echo "âŒ NÃ£o foi possÃ­vel verificar variÃ¡veis"
                    
                    echo "ğŸ§ª Testando serviÃ§os..."
                    
                    # Teste backend
                    if curl -s -f http://localhost:3000 > /dev/null; then
                        echo "ğŸ‰ Backend ONLINE - http://23.22.57.128:3000"
                    else
                        echo "âŒ Backend OFFLINE"
                        docker-compose -f Code/docker-compose.yml logs backend
                    fi
                    
                    # Teste frontend  
                    if curl -s -f http://localhost:80 > /dev/null; then
                        echo "ğŸ‰ Frontend ONLINE - http://23.22.57.128"
                    else
                        echo "âŒ Frontend OFFLINE"
                        docker-compose -f Code/docker-compose.yml logs frontend
                    fi
                '''
            }
        }
    }
    
    post {
        success {
            echo "ğŸŠ DEPLOY SUCESSO!"
            echo "ğŸŒ Frontend: http://23.22.57.128"
            echo "ğŸ”§ Backend: http://23.22.57.128:3000"
        }
        failure {
            echo "ğŸ’¥ DEPLOY FALHOU"
        }
    }
}