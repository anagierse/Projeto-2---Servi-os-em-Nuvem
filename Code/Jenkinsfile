pipeline {
    agent any
    
    stages {
        stage('📥 Checkout') {
            steps {
                checkout scm
                sh '''
                    echo "✅ Código baixado"
                    echo "📄 Verificando arquivo .env:"
                    ls -la Code/.env || echo "❌ .env não encontrado"
                    ls -la Code/env || echo "❌ env não encontrado"
                '''
            }
        }
        
        stage('🚀 Deploy com Docker Compose') {
            steps {
                sh '''
                    echo "🎯 Usando Docker Compose para deploy..."
                    cd Code
                    
                    # Para os serviços sem remover volumes (mantém dados)
                    docker-compose down
                    
                    # Constrói e sobe os serviços
                    docker-compose up -d --build
                    
                    echo "⏳ Aguardando inicialização..."
                    sleep 30
                '''
            }
        }
        
        stage('✅ Health Check') {
            steps {
                sh '''
                    echo "📊 Status dos serviços:"
                    cd Code && docker-compose ps
                    
                    echo "🔍 Verificando variáveis no backend:"
                    docker-compose -f Code/docker-compose.yml exec -T backend printenv | grep DB || echo "❌ Não foi possível verificar variáveis"
                    
                    echo "🧪 Testando serviços..."
                    
                    # Teste backend
                    if curl -s -f http://localhost:3000 > /dev/null; then
                        echo "🎉 Backend ONLINE - http://23.22.57.128:3000"
                    else
                        echo "❌ Backend OFFLINE"
                        docker-compose -f Code/docker-compose.yml logs backend
                    fi
                    
                    # Teste frontend  
                    if curl -s -f http://localhost:80 > /dev/null; then
                        echo "🎉 Frontend ONLINE - http://23.22.57.128"
                    else
                        echo "❌ Frontend OFFLINE"
                        docker-compose -f Code/docker-compose.yml logs frontend
                    fi
                '''
            }
        }
    }
    
    post {
        success {
            echo "🎊 DEPLOY SUCESSO!"
            echo "🌐 Frontend: http://23.22.57.128"
            echo "🔧 Backend: http://23.22.57.128:3000"
        }
        failure {
            echo "💥 DEPLOY FALHOU"
        }
    }
}