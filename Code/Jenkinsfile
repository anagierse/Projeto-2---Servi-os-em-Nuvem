pipeline {
    agent any

    environment {
        CODE_DIR = "${WORKSPACE}/Code"
    }

    stages {
        stage('ðŸ“¥ Checkout') {
            steps {
                checkout scm
                sh '''
                    echo "ðŸ“ Estrutura do projeto:"
                    ls -la $CODE_DIR
                    echo "âœ… Checkout completo"
                '''
            }
        }

        stage('ðŸ›  Criar env seguro') {
            steps {
                withCredentials([
                    string(credentialsId: 'DB_HOST', variable: 'DB_HOST'),
                    string(credentialsId: 'DB_PORT', variable: 'DB_PORT'),
                    string(credentialsId: 'DB_NAME', variable: 'DB_NAME'),
                    string(credentialsId: 'DB_USER', variable: 'DB_USER'),
                    string(credentialsId: 'DB_PASSWORD', variable: 'DB_PASSWORD')
                ]) {
                    sh '''
                        echo "DB_HOST=$DB_HOST" > $CODE_DIR/env
                        echo "DB_PORT=$DB_PORT" >> $CODE_DIR/env
                        echo "DB_NAME=$DB_NAME" >> $CODE_DIR/env
                        echo "DB_USER=$DB_USER" >> $CODE_DIR/env
                        echo "DB_PASSWORD=$DB_PASSWORD" >> $CODE_DIR/env
                        ls -la $CODE_DIR
                        cat $CODE_DIR/env
                    '''
                }
            }
        }

        stage('ðŸ³ Build Containers') {
            steps {
                sh '''
                    cd $CODE_DIR/backend && docker build -t code-backend . && cd ../..
                    cd $CODE_DIR/frontend && docker build -t code-frontend . && cd ../..
                '''
            }
        }

        stage('ðŸš€ Deploy') {
            steps {
                sh '''
                    docker stop code-backend-1 code-frontend-1 2>/dev/null || true
                    docker rm code-backend-1 code-frontend-1 2>/dev/null || true

                    docker run -d --name code-backend-1 --env-file "$CODE_DIR/env" -p 3000:3000 code-backend
                    docker run -d --name code-frontend-1 -p 80:80 code-frontend
                    sleep 25
                '''
            }
        }
    }

    post {
        success {
            echo "ðŸŽŠ DEPLOY SUCESSO!"
        }
        failure {
            echo "ðŸ’¥ DEPLOY FALHOU"
        }
    }
}
